Rewrite the LayeredFS pattern searching, small cleanup
